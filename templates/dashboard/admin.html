{% extends "base.html" %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col-md-2 text-center">
        <img src="{{ url_for('static', filename='uploads/' + current_user.profile_photo) }}" class="rounded-circle" width="90" height="90" alt="Profile Photo" onerror="this.onerror=null;this.src='https://via.placeholder.com/90x90/6c757d/ffffff?text=USER';">
        <div class="mt-2 fw-bold">{{ current_user.username }}</div>
    </div>
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ users|length }}</h3>
                        <small>Total Users</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ total_tasks }}</h3>
                        <small>Total Tasks</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ completed_tasks }}</h3>
                        <small>Completed Tasks</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>User Activity Overview</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Recent Activity</h5>
            </div>
            <div class="card-body">
                {% for task in recent_tasks %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ task.title }}</strong><br>
                        <small>{{ task.user.username }}</small>
                    </div>
                    <span class="badge bg-{{ 'success' if task.status == 'completed' else 'primary' }}">
                        {{ task.status.replace('_', ' ').title() }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>All Users</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Tasks</th>
                                <th>Completed</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.tasks|length }}</td>
                                <td>{{ Task.query.filter_by(user_id=user.id, status='completed').count() }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewUserTaskHistory({{ user.id }}, '{{ user.username }}')" tabindex="0" aria-label="View Task History for {{ user.username }}">
                                        <i class="fas fa-history" aria-hidden="true"></i> View Task History
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// User Activity Overview Chart: show total time spent and number of tasks per day of week
fetch('/api/analytics/activity/weekly')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('activityChart').getContext('2d');
        const labels = data.map(d => d.day);
        const totalTime = data.map(d => d.total_time);
        const taskCount = data.map(d => d.task_count);
        // Helper to format hours as hh:mm:ss
        function formatHoursToHMS(hours) {
            const totalSeconds = Math.round(hours * 3600);
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Time Spent',
                        data: totalTime,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        yAxisID: 'y',
                    },
                    {
                        label: 'Number of Tasks',
                        data: taskCount,
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y1',
                        tension: 0.2,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label === 'Total Time Spent') {
                                    return 'Total Time: ' + formatHoursToHMS(context.parsed.y);
                                } else if (context.dataset.label === 'Number of Tasks') {
                                    return 'Tasks: ' + context.parsed.y;
                                }
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: { display: true, text: 'Total Time (hh:mm:ss)' },
                        ticks: {
                            callback: function(value) {
                                return formatHoursToHMS(value);
                            }
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: 'Number of Tasks' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    });

function viewUserTaskHistory(userId, username) {
    fetch(`/api/tasks/user/${userId}/history`)
        .then(response => response.json())
        .then(data => {
            let html = `<div class='mb-3 text-center'>
                <span class='fs-5 fw-bold'><i class='fas fa-history text-primary'></i> Task History for <b>${username}</b></span>
            </div>`;
            if (data.length === 0) {
                html += '<div class="alert alert-info text-center">No tasks found.</div>';
            } else {
                html += `<div class='table-responsive'><table class='table table-hover align-middle'>
                <thead class='table-light'>
                <tr>
                    <th><i class='fas fa-tasks'></i> Title</th>
                    <th><i class='fas fa-flag'></i> Status</th>
                    <th><i class='fas fa-bolt'></i> Priority</th>
                    <th><i class='fas fa-layer-group'></i> Category</th>
                    <th><i class='fas fa-calendar-plus'></i> Created</th>
                    <th><i class='fas fa-hourglass-start'></i> Started</th>
                    <th><i class='fas fa-calendar-check'></i> Completed</th>
                    <th><i class='fas fa-clock'></i> Actual Time</th>
                </tr></thead><tbody>`;
                for (const t of data) {
                    // Format datetimes as ISO 8601 (YYYY-MM-DD HH:mm)
                    const created = t.created_at ? new Date(t.created_at.replace(' ', 'T')).toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
                    const started = t.started_at ? new Date(t.started_at.replace(' ', 'T')).toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
                    const completed = t.completed_at ? new Date(t.completed_at.replace(' ', 'T')).toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
                    // Format actual_time as hh:mm:ss if present
                    let actualTime = '-';
                    if (t.actual_time !== null && t.actual_time !== undefined) {
                        const totalSeconds = Math.round(t.actual_time * 3600);
                        const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                        const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                        const s = (totalSeconds % 60).toString().padStart(2, '0');
                        actualTime = `<span class='fw-bold text-primary'>${h}:${m}:${s}</span>`;
                    }
                    html += `<tr>
                        <td>${t.title}</td>
                        <td><span class='badge bg-${t.status === 'completed' ? 'success' : t.status === 'in_progress' ? 'primary' : 'secondary'} text-capitalize'>${t.status.replace('_',' ')}</span></td>
                        <td><span class='badge bg-${t.priority === 'high' ? 'danger' : t.priority === 'medium' ? 'warning' : 'secondary'} text-capitalize'>${t.priority}</span></td>
                        <td>${t.category || ''}</td>
                        <td>${created}</td>
                        <td>${started}</td>
                        <td>${completed}</td>
                        <td>${actualTime}</td>
                    </tr>`;
                }
                html += '</tbody></table></div>';
            }
            document.getElementById('taskHistoryModalTitle').innerHTML = `<i class='fas fa-history text-primary'></i> Task History - <span class='fw-bold'>${username}</span>`;
            document.getElementById('taskHistoryModalBody').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('userTaskHistoryModal'));
            modal.show();
        });
}
// User Task History Modal (should only be defined once, outside the table row)
</script>
<div class="modal fade" id="userTaskHistoryModal" tabindex="-1" role="dialog" aria-labelledby="taskHistoryModalTitle" aria-modal="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header" style="background: #2050a0; color: #fff;">
        <h5 class="modal-title w-100 text-center" id="taskHistoryModalTitle" aria-label="User Task History"><i class="fas fa-history"></i> User Task History</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close Task History Modal"></button>
      </div>
      <div class="modal-body p-4" id="taskHistoryModalBody" style="background: #f5f7fa; min-height: 300px; color: #1a1a1a;">
        <!-- Task history content will be injected here -->
      </div>
      <div class="modal-footer justify-content-center bg-light" role="contentinfo">
        <button type="button" class="btn btn-outline-primary px-4" data-bs-dismiss="modal" aria-label="Close Task History Modal"><i class="fas fa-times" aria-hidden="true"></i> Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}